<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VO3 Script Chunker</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0e27;
            min-height: 100vh;
            padding: 0;
            color: #e8eaf6;
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(79, 70, 229, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }
        
        .header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 0.8s ease;
        }
        
        .header h1 {
            font-size: 3.5em;
            font-weight: 800;
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 50%, #f472b6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }
        
        .header p {
            font-size: 1.2em;
            color: #a5b4fc;
            font-weight: 300;
        }
        
        .setup-section {
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(129, 140, 248, 0.2);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.8s ease 0.2s backwards;
        }
        
        .setup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(129, 140, 248, 0.2);
        }
        
        .setup-header h2 {
            font-size: 1.8em;
            font-weight: 700;
            color: #c7d2fe;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .collapse-icon {
            font-size: 1.5em;
            color: #818cf8;
            transition: transform 0.3s ease;
        }
        
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        
        .setup-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.4s ease;
        }
        
        .collapsed .setup-content {
            max-height: 0;
            opacity: 0;
        }
        
        .input-group {
            position: relative;
        }
        
        .input-group label {
            display: block;
            font-size: 0.95em;
            font-weight: 600;
            color: #c7d2fe;
            margin-bottom: 10px;
            letter-spacing: 0.02em;
        }
        
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group input[type="file"],
        .input-group textarea {
            width: 100%;
            padding: 14px 18px;
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid rgba(129, 140, 248, 0.3);
            border-radius: 12px;
            color: #e8eaf6;
            font-size: 1em;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }
        
        .input-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #818cf8;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.1);
        }
        
        .input-hint {
            font-size: 0.85em;
            color: #94a3b8;
            margin-top: 8px;
            line-height: 1.5;
        }
        
        .input-hint a {
            color: #818cf8;
            text-decoration: none;
            font-weight: 600;
        }
        
        .input-hint a:hover {
            text-decoration: underline;
        }
        
        .slider-group {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .slider-group input[type="range"] {
            flex: 1;
            height: 6px;
            background: rgba(129, 140, 248, 0.2);
            border-radius: 10px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider-group input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #818cf8, #c084fc);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(129, 140, 248, 0.5);
        }
        
        .slider-group input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, #818cf8, #c084fc);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(129, 140, 248, 0.5);
        }
        
        .slider-value {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.95em;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 12px;
            padding: 12px;
            background: rgba(129, 140, 248, 0.05);
            border-radius: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #818cf8;
        }
        
        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
            font-size: 0.95em;
        }
        
        .warning-box {
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease;
        }
        
        .warning-box.show {
            display: block;
        }
        
        .warning-success {
            background: rgba(34, 197, 94, 0.15);
            border: 2px solid rgba(34, 197, 94, 0.4);
            color: #86efac;
        }
        
        .warning-error {
            background: rgba(239, 68, 68, 0.15);
            border: 2px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .progress-bar {
            margin-top: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease, background 0.3s ease;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            animation: fadeIn 0.8s ease 0.4s backwards;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .content-panel {
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(129, 140, 248, 0.2);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .panel-header {
            font-size: 1.8em;
            font-weight: 700;
            color: #c7d2fe;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .script-input {
            width: 100%;
            min-height: 450px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid rgba(129, 140, 248, 0.3);
            border-radius: 16px;
            color: #e8eaf6;
            font-size: 1.05em;
            font-family: 'Outfit', sans-serif;
            line-height: 1.8;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .script-input:focus {
            outline: none;
            border-color: #818cf8;
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.1);
        }
        
        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 24px rgba(79, 70, 229, 0.4);
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(79, 70, 229, 0.5);
        }
        
        .generate-btn:active {
            transform: translateY(0);
        }
        
        .takes-output {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .takes-output::-webkit-scrollbar {
            width: 8px;
        }
        
        .takes-output::-webkit-scrollbar-track {
            background: rgba(129, 140, 248, 0.1);
            border-radius: 10px;
        }
        
        .takes-output::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            border-radius: 10px;
        }
        
        .take-card {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            animation: slideInUp 0.4s ease backwards;
        }
        
        .take-card:nth-child(1) { animation-delay: 0s; }
        .take-card:nth-child(2) { animation-delay: 0.1s; }
        .take-card:nth-child(3) { animation-delay: 0.2s; }
        .take-card:nth-child(4) { animation-delay: 0.3s; }
        .take-card:nth-child(5) { animation-delay: 0.4s; }
        
        .take-card:hover {
            border-color: #818cf8;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(129, 140, 248, 0.2);
        }
        
        .take-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .take-badge {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9em;
        }
        
        .take-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .take-duration {
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Outfit', sans-serif;
        }
        
        .btn-copy {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border: 1px solid rgba(34, 197, 94, 0.4);
        }
        
        .btn-copy:hover {
            background: rgba(34, 197, 94, 0.3);
            transform: translateY(-2px);
        }
        
        .btn-generate {
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        
        .btn-generate:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.4);
        }
        
        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .take-content {
            line-height: 1.8;
            font-size: 1.05em;
            color: #cbd5e1;
            margin-bottom: 12px;
        }
        
        .filler {
            background: rgba(239, 68, 68, 0.2);
            padding: 3px 8px;
            border-radius: 6px;
            color: #fca5a5;
            font-style: italic;
            text-decoration: line-through;
        }
        
        .overlap {
            background: rgba(251, 146, 60, 0.2);
            padding: 3px 8px;
            border-radius: 6px;
            color: #fdba74;
        }
        
        .main-content-text {
            background: rgba(34, 197, 94, 0.1);
            padding: 3px 8px;
            border-radius: 6px;
            color: #86efac;
        }
        
        .status-badge {
            margin-top: 12px;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            display: none;
        }
        
        .status-badge.show {
            display: block;
        }
        
        .status-success {
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.4);
            color: #86efac;
        }
        
        .status-pending {
            background: rgba(251, 146, 60, 0.15);
            border: 1px solid rgba(251, 146, 60, 0.4);
            color: #fdba74;
        }
        
        .status-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
        }
        
        .export-section {
            margin-top: 40px;
            padding: 24px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(129, 140, 248, 0.3);
            border-radius: 16px;
        }
        
        .export-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .export-header h3 {
            font-size: 1.3em;
            font-weight: 700;
            color: #c7d2fe;
        }
        
        .export-textarea {
            width: 100%;
            min-height: 250px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(129, 140, 248, 0.2);
            border-radius: 12px;
            color: #cbd5e1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9em;
            line-height: 1.6;
            resize: vertical;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            color: #94a3b8;
        }
        
        .legend-box {
            width: 24px;
            height: 24px;
            border-radius: 6px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        .footer {
            text-align: center;
            padding: 40px 20px;
            color: #94a3b8;
            font-size: 0.95em;
            animation: fadeIn 0.8s ease 0.6s backwards;
        }
        
        .footer a {
            color: #818cf8;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .footer a:hover {
            color: #c084fc;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è VEO3 Script Chunker</h1>
            <p>Break down your scripts into perfect 8-second VEO3 chunks with smart overlap</p>
        </div>
        
        <!-- Collapsible Setup Section -->
        <div class="setup-section collapsed" id="setupSection">
            <div class="setup-header" onclick="toggleSetup()">
                <h2>‚öôÔ∏è Setup & Configuration</h2>
                <span class="collapse-icon">‚ñº</span>
            </div>
            
            <div class="setup-content">
                <div class="input-group">
                    <label>üé¨ VEO3 Visual Prompt (scene description, style, camera)</label>
                    <textarea id="vo3Prompt" placeholder="Example: A professional woman in scrubs sitting at a kitchen table, warm lighting, cinematic shot, documentary style, close-up on face"></textarea>
                    <div class="input-hint">
                        This visual prompt will be combined with each take's text as: <strong>[Your prompt] ; spoken text: "[take text]"</strong>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>üñºÔ∏è Starting Frame Image (optional)</label>
                    <input type="file" id="imageUpload" accept="image/*">
                    <div id="imagePreview" style="margin-top: 10px; display: none;">
                        <img id="previewImg" style="max-width: 100%; max-height: 150px; border-radius: 12px; border: 2px solid rgba(129, 140, 248, 0.3);">
                        <button onclick="clearImage()" class="btn btn-copy" style="margin-top: 8px; background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.4);">Remove Image</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Target Script Duration (seconds)</label>
                    <div class="slider-group">
                        <input type="range" id="scriptDuration" min="15" max="120" step="5" value="45">
                        <span class="slider-value" id="scriptDurationValue">45s</span>
                    </div>
                </div>
                
                <div id="durationWarning" class="warning-box">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span id="warningIcon"></span>
                        <span id="warningText"></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Target Duration per Take (seconds)</label>
                    <div class="slider-group">
                        <input type="range" id="duration" min="5" max="9" step="0.5" value="7">
                        <span class="slider-value" id="durationValue">7s</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Overlap Duration (seconds)</label>
                    <div class="slider-group">
                        <input type="range" id="overlap" min="1" max="4" step="0.5" value="2">
                        <span class="slider-value" id="overlapValue">2s</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Filler Prefix (optional - will be cut in editing)</label>
                    <input type="text" id="filler" placeholder="e.g., So anyway, or Like I was saying," value="So anyway,">
                    <div class="checkbox-group">
                        <input type="checkbox" id="fillerAllTakes">
                        <label for="fillerAllTakes">Add filler prefix to all takes (not just the first one)</label>
                    </div>
                </div>
                
                <div class="input-group">
                    <label>Number of Variations per Take (1-4)</label>
                    <input type="number" id="globalVariations" min="1" max="4" value="1" oninput="updateAllTakeVariations()" style="width: 100px; padding: 12px; background: rgba(15, 23, 42, 0.5); border: 2px solid rgba(129, 140, 248, 0.3); border-radius: 10px; color: #e8eaf6; text-align: center; font-weight: 600; font-size: 1.1em;">
                    <div class="input-hint">
                        Generate multiple variations of each video to choose the best one. This sets the default for all takes (can be adjusted individually).
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Left Panel - Input -->
            <div class="content-panel">
                <h2 class="panel-header">üìù Input Script</h2>
                <textarea class="script-input" id="scriptInput" placeholder="Paste your script here..."></textarea>
                <button class="generate-btn" onclick="processScript()">‚ú® Generate VEO3 Takes</button>
            </div>
            
            <!-- Right Panel - Output -->
            <div class="content-panel">
                <h2 class="panel-header">üé¨ VEO3 Takes</h2>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(239, 68, 68, 0.2);"></div>
                        <span><strong>Filler</strong> - Cut in edit</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(251, 146, 60, 0.2);"></div>
                        <span><strong>Overlap</strong> - For smooth transitions</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-box" style="background: rgba(34, 197, 94, 0.1);"></div>
                        <span><strong>Main</strong> - Keep this content</span>
                    </div>
                </div>
                
                <div class="takes-output" id="output">
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <p>Your VO3 takes will appear here</p>
                    </div>
                </div>
                
                <div class="export-section" id="exportSection" style="display: none;">
                    <div class="export-header">
                        <h3>üìã Copy/Paste Format</h3>
                        <button class="btn btn-copy" onclick="copyAllTakes()">Copy All Takes</button>
                    </div>
                    <textarea class="export-textarea" id="exportText" readonly></textarea>
                </div>
            </div>
        </div>
        
        <div class="footer">
            Created by <strong>Amber Jones</strong> @ <strong>HomePro Media</strong>
        </div>
    </div>

    <script>
        // Toggle setup section
        function toggleSetup() {
            const setupSection = document.getElementById('setupSection');
            setupSection.classList.toggle('collapsed');
        }
        
        // Update slider values display
        document.getElementById('duration').addEventListener('input', function() {
            document.getElementById('durationValue').textContent = this.value + 's';
        });
        
        document.getElementById('overlap').addEventListener('input', function() {
            document.getElementById('overlapValue').textContent = this.value + 's';
        });
        
        document.getElementById('scriptDuration').addEventListener('input', function() {
            document.getElementById('scriptDurationValue').textContent = this.value + 's';
            updateDurationWarning();
        });
        
        // Live update duration warning as user types
        document.getElementById('scriptInput').addEventListener('input', function() {
            updateDurationWarning();
        });
        
        // Image upload handling
        let uploadedImageBase64 = null;
        
        document.getElementById('imageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    uploadedImageBase64 = event.target.result;
                    document.getElementById('previewImg').src = uploadedImageBase64;
                    document.getElementById('imagePreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });
        
        function clearImage() {
            uploadedImageBase64 = null;
            document.getElementById('imageUpload').value = '';
            document.getElementById('imagePreview').style.display = 'none';
        }
        
        function updateDurationWarning() {
            const script = document.getElementById('scriptInput').value.trim();
            const targetDuration = parseFloat(document.getElementById('scriptDuration').value);
            const warningDiv = document.getElementById('durationWarning');
            const warningIcon = document.getElementById('warningIcon');
            const warningText = document.getElementById('warningText');
            const progressBar = document.getElementById('progressBar');
            
            if (!script) {
                warningDiv.classList.remove('show');
                warningDiv.style.display = 'none';
                return;
            }
            
            const estimatedDuration = estimateDuration(script);
            const percentage = (estimatedDuration / targetDuration) * 100;
            
            warningDiv.style.display = 'block';
            warningDiv.classList.add('show');
            progressBar.style.width = Math.min(percentage, 100) + '%';
            
            if (estimatedDuration > targetDuration) {
                const overBy = (estimatedDuration - targetDuration).toFixed(1);
                warningDiv.className = 'warning-box show warning-error';
                warningIcon.textContent = '‚ö†Ô∏è';
                warningText.textContent = `Script is ~${estimatedDuration.toFixed(1)}s (${overBy}s over ${targetDuration}s target)`;
                progressBar.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
            } else {
                const underBy = (targetDuration - estimatedDuration).toFixed(1);
                warningDiv.className = 'warning-box show warning-success';
                warningIcon.textContent = '‚úì';
                warningText.textContent = `Script is ~${estimatedDuration.toFixed(1)}s (${underBy}s under ${targetDuration}s target)`;
                progressBar.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
            }
        }
        
        function estimateDuration(text) {
            // Average speaking rate: ~150 words per minute = 2.5 words per second
            const words = text.trim().split(/\s+/).length;
            return words / 2.5;
        }
        
        function splitIntoSentences(text) {
            // Split on sentence boundaries but keep the punctuation
            return text.match(/[^.!?]+[.!?]+/g) || [text];
        }
        
        function processScript() {
            const script = document.getElementById('scriptInput').value.trim();
            const targetDuration = parseFloat(document.getElementById('duration').value);
            const overlapDuration = parseFloat(document.getElementById('overlap').value);
            const fillerPrefix = document.getElementById('filler').value.trim();
            
            if (!script) {
                document.getElementById('output').innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <p>Please paste a script first</p>
                    </div>
                `;
                return;
            }
            
            // Split script into sentences
            const sentences = splitIntoSentences(script);
            const takes = [];
            const minDuration = targetDuration - 1.5; // Acceptable range: target ¬± 1.5s
            const maxDuration = targetDuration + 1.5;
            
            let i = 0;
            while (i < sentences.length) {
                const sentence = sentences[i].trim();
                const sentenceDuration = estimateDuration(sentence);
                
                // If this sentence alone is in acceptable range, use it as-is (no overlap)
                if (sentenceDuration >= minDuration && sentenceDuration <= maxDuration) {
                    takes.push({
                        text: sentence,
                        duration: sentenceDuration,
                        overlap: null, // No overlap needed
                        previousOverlap: null,
                        needsOverlap: false
                    });
                    i++;
                }
                // If sentence is too short, try combining with next sentence(s)
                else if (sentenceDuration < minDuration) {
                    let combinedText = sentence;
                    let combinedDuration = sentenceDuration;
                    let endIndex = i;
                    
                    // Keep adding sentences until we hit a good duration
                    while (endIndex + 1 < sentences.length && combinedDuration < minDuration) {
                        endIndex++;
                        const nextSentence = sentences[endIndex].trim();
                        const nextDuration = estimateDuration(nextSentence);
                        
                        // Check if adding full sentence would be too much
                        if (combinedDuration + nextDuration > maxDuration) {
                            // Add only part of the next sentence
                            const words = nextSentence.split(/\s+/);
                            const wordsNeeded = Math.ceil((targetDuration - combinedDuration) * 2.5);
                            const partialText = words.slice(0, wordsNeeded).join(' ');
                            
                            // Create overlap zone
                            const overlapWords = Math.ceil(overlapDuration * 2.5);
                            const overlapText = words.slice(0, overlapWords).join(' ');
                            
                            takes.push({
                                text: combinedText + ' ' + partialText,
                                duration: estimateDuration(combinedText + ' ' + partialText),
                                overlap: overlapText,
                                previousOverlap: null,
                                needsOverlap: true
                            });
                            
                            // Next take starts with the overlap
                            i = endIndex;
                            break;
                        } else {
                            // Add the full sentence
                            combinedText += ' ' + nextSentence;
                            combinedDuration += nextDuration;
                            
                            // If we're now in good range, save it
                            if (combinedDuration >= minDuration) {
                                takes.push({
                                    text: combinedText,
                                    duration: combinedDuration,
                                    overlap: null,
                                    previousOverlap: null,
                                    needsOverlap: false
                                });
                                i = endIndex + 1;
                                break;
                            }
                        }
                    }
                    
                    // If we've reached the end, add what we have
                    if (endIndex === sentences.length - 1 && i <= endIndex) {
                        takes.push({
                            text: combinedText,
                            duration: combinedDuration,
                            overlap: null,
                            previousOverlap: null,
                            needsOverlap: false
                        });
                        i = endIndex + 1;
                    }
                }
                // If sentence is too long, we need to split it
                else {
                    const words = sentence.split(/\s+/);
                    const targetWords = Math.ceil(targetDuration * 2.5);
                    const chunk = words.slice(0, targetWords).join(' ');
                    
                    // Create overlap
                    const overlapWords = Math.ceil(overlapDuration * 2.5);
                    const overlapText = words.slice(0, overlapWords).join(' ');
                    
                    takes.push({
                        text: chunk,
                        duration: estimateDuration(chunk),
                        overlap: overlapText,
                        previousOverlap: null,
                        needsOverlap: true
                    });
                    
                    // Put the rest back as a new sentence for next iteration
                    const remainder = words.slice(targetWords).join(' ');
                    sentences[i] = remainder;
                    // Don't increment i, process the remainder next
                }
            }
            
            // Now process overlaps between takes
            for (let j = 1; j < takes.length; j++) {
                const prevTake = takes[j - 1];
                if (prevTake.needsOverlap && prevTake.overlap) {
                    takes[j].previousOverlap = prevTake.overlap;
                }
            }
            
            // Render takes
            renderTakes(takes, fillerPrefix);
        }
        
        // Store take data for copying
        let takesData = [];
        
        function renderTakes(takes, fillerPrefix) {
            const output = document.getElementById('output');
            const exportSection = document.getElementById('exportSection');
            const exportText = document.getElementById('exportText');
            const fillerAllTakes = document.getElementById('fillerAllTakes').checked;
            const veo3Prompt = document.getElementById('vo3Prompt').value.trim();
            
            // Reset takes data
            takesData = [];
            
            if (takes.length === 0) {
                output.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                        </svg>
                        <p>Your VEO3 takes will appear here</p>
                    </div>
                `;
                exportSection.style.display = 'none';
                return;
            }
            
            let html = '';
            let exportContent = '';
            
            takes.forEach((take, index) => {
                const takeNumber = index + 1;
                // Add filler to first take OR all takes if checkbox is checked
                const hasFillerPrefix = fillerPrefix && (index === 0 || fillerAllTakes);
                const hasPreviousOverlap = take.previousOverlap;
                const hasNextOverlap = take.needsOverlap && take.overlap;
                
                // Build the full take text (just the spoken part)
                let fullText = '';
                if (hasFillerPrefix) {
                    fullText = fillerPrefix + ' ';
                }
                if (hasPreviousOverlap) {
                    fullText += take.previousOverlap + ' ';
                }
                fullText += take.text;
                
                // Build the full VEO3 prompt (visual + spoken)
                let fullVeo3Prompt = '';
                if (veo3Prompt) {
                    fullVeo3Prompt = `${veo3Prompt} ; spoken text: "${fullText}"`;
                }
                
                // Store in takesData array
                takesData[takeNumber - 1] = {
                    takeText: fullText,
                    fullPrompt: fullVeo3Prompt
                };
                
                // Build HTML with highlighting
                let contentHtml = '';
                if (hasFillerPrefix) {
                    contentHtml += `<span class="filler">${fillerPrefix}</span> `;
                }
                if (hasPreviousOverlap) {
                    contentHtml += `<span class="overlap">${take.previousOverlap}</span> `;
                }
                
                // Highlight the main content and overlap if exists
                if (hasNextOverlap) {
                    const overlapStart = take.text.indexOf(take.overlap);
                    if (overlapStart === 0) {
                        const mainContent = take.text.substring(take.overlap.length);
                        contentHtml += `<span class="overlap">${take.overlap}</span> <span class="main-content-text">${mainContent}</span>`;
                    } else {
                        const mainContent = take.text.substring(0, take.text.lastIndexOf(take.overlap));
                        contentHtml += `<span class="main-content-text">${mainContent}</span> <span class="overlap">${take.overlap}</span>`;
                    }
                } else {
                    contentHtml += `<span class="main-content-text">${take.text}</span>`;
                }
                
                // Add note if no overlap needed
                let statusNote = '';
                if (!hasPreviousOverlap && !hasNextOverlap) {
                    statusNote = '<div style="margin-top: 12px; font-size: 0.9em; color: #86efac;">‚úì Complete sentence - no overlap needed</div>';
                }
                
                html += `
                    <div class="take-card">
                        <div class="take-header">
                            <span class="take-badge">Take ${takeNumber}</span>
                            <div class="take-actions">
                                <span class="take-duration">~${take.duration.toFixed(1)}s</span>
                                <button class="btn btn-copy" onclick="copyTakeByIndex(${takeNumber - 1}, 'text')">Copy Take</button>
                                ${veo3Prompt ? `<button class="btn btn-copy" onclick="copyTakeByIndex(${takeNumber - 1}, 'prompt')" style="background: rgba(139, 92, 246, 0.2); color: #c084fc; border: 1px solid rgba(139, 92, 246, 0.4);">Copy Full Prompt</button>` : ''}
                            </div>
                        </div>
                        <div class="take-content">
                            ${contentHtml}
                        </div>
                        ${statusNote}
                        <div style="display: flex; align-items: center; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(129, 140, 248, 0.2);">
                            <label style="font-size: 0.9em; color: #94a3b8; white-space: nowrap;">Variations:</label>
                            <input type="number" class="take-variations" id="variations${takeNumber}" min="1" max="4" value="${document.getElementById('globalVariations')?.value || 1}" style="width: 70px; padding: 8px; background: rgba(15, 23, 42, 0.5); border: 2px solid rgba(129, 140, 248, 0.3); border-radius: 8px; color: #e8eaf6; text-align: center; font-weight: 600;">
                            <button class="btn btn-generate" id="genBtn${takeNumber}" onclick="generateInVEO3(${takeNumber}, ${takeNumber - 1})" style="flex: 1;">
                                üé¨ Generate in VEO3
                            </button>
                        </div>
                        <div class="status-badge" id="status${takeNumber}"></div>
                        <div id="previews${takeNumber}" style="margin-top: 16px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;"></div>
                    </div>
                `;
                
                // Build export text format
                exportContent += `TAKE ${takeNumber} (~${take.duration.toFixed(1)}s)\n`;
                if (hasFillerPrefix) {
                    exportContent += `[FILLER: ${fillerPrefix}] `;
                }
                if (hasPreviousOverlap) {
                    exportContent += `[OVERLAP: ${take.previousOverlap}] `;
                }
                exportContent += `${take.text}\n\n`;
            });
            
            output.innerHTML = html;
            exportText.value = exportContent;
            exportSection.style.display = 'block';
        }
        
        function copyTakeByIndex(index, type) {
            const takeData = takesData[index];
            if (!takeData) return;
            
            const textToCopy = type === 'text' ? takeData.takeText : takeData.fullPrompt;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                console.log('Copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }
        
        function updateAllTakeVariations() {
            const globalValue = document.getElementById('globalVariations').value;
            const takeVariationsInputs = document.querySelectorAll('.take-variations');
            takeVariationsInputs.forEach(input => {
                input.value = globalValue;
            });
        }
        
        function escapeHtml(text) {
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        function copyTake(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could add a toast notification here
                console.log('Copied to clipboard');
            });
        }
        
        function copyAllTakes() {
            const exportText = document.getElementById('exportText').value;
            navigator.clipboard.writeText(exportText).then(() => {
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úì Copied!';
                button.style.background = '#28a745';
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = '';
                }, 2000);
            });
        }
        
        async function generateInVEO3(takeNumber, takeIndex) {
            const vo3Prompt = document.getElementById('vo3Prompt').value.trim();
            const statusDiv = document.getElementById(`status${takeNumber}`);
            const button = document.getElementById(`genBtn${takeNumber}`);
            const previewsDiv = document.getElementById(`previews${takeNumber}`);
            const variationsInput = document.getElementById(`variations${takeNumber}`);
            const numVariations = parseInt(variationsInput.value) || 1;
            
            // Get the take text from takesData
            const takeData = takesData[takeIndex];
            if (!takeData) {
                statusDiv.innerHTML = '‚ö†Ô∏è Take data not found';
                statusDiv.className = 'status-badge show status-error';
                return;
            }
            
            const prompt = takeData.takeText;
            
            // Validation
            if (!vo3Prompt) {
                statusDiv.innerHTML = '‚ö†Ô∏è Please enter a VEO3 Visual Prompt above';
                statusDiv.className = 'status-badge show status-error';
                return;
            }
            
            // Combine VEO3 prompt with take text
            const fullPrompt = `${vo3Prompt} ; spoken text: "${prompt}"`;
            
            // Update UI to show generation in progress
            button.disabled = true;
            button.style.opacity = '0.5';
            button.textContent = '‚è≥ Generating...';
            statusDiv.innerHTML = `üé¨ Generating ${numVariations} variation${numVariations > 1 ? 's' : ''}...`;
            statusDiv.className = 'status-badge show status-pending';
            previewsDiv.innerHTML = '';
            
            try {
                // Generate multiple variations
                const generationPromises = [];
                for (let i = 0; i < numVariations; i++) {
                    generationPromises.push(generateSingleVideo(null, fullPrompt, takeNumber, i + 1));
                }
                
                const results = await Promise.all(generationPromises);
                
                // Display all results
                let successCount = 0;
                let html = '';
                results.forEach((result, index) => {
                    if (result.success) {
                        successCount++;
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(129, 140, 248, 0.3); border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 600; color: #c7d2fe; margin-bottom: 10px;">Variation ${index + 1}</div>
                                ${result.videoUrl ? `
                                    <video controls style="width: 100%; border-radius: 8px; margin-bottom: 10px;">
                                        <source src="${result.videoUrl}" type="video/mp4">
                                    </video>
                                    <a href="${result.videoUrl}" download class="btn btn-copy" style="width: 100%; text-align: center; display: block;">Download</a>
                                ` : `
                                    <div style="color: #86efac; font-size: 0.9em;">‚úÖ Generated! Check Flow dashboard</div>
                                `}
                            </div>
                        `;
                    } else {
                        html += `
                            <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 600; color: #fca5a5; margin-bottom: 10px;">Variation ${index + 1}</div>
                                <div style="color: #fca5a5; font-size: 0.9em;">‚ùå ${result.error}</div>
                            </div>
                        `;
                    }
                });
                
                previewsDiv.innerHTML = html;
                
                if (successCount === numVariations) {
                    statusDiv.innerHTML = `‚úÖ All ${numVariations} variation${numVariations > 1 ? 's' : ''} generated!`;
                    statusDiv.className = 'status-badge show status-success';
                } else if (successCount > 0) {
                    statusDiv.innerHTML = `‚ö†Ô∏è ${successCount} of ${numVariations} variations generated successfully`;
                    statusDiv.className = 'status-badge show status-pending';
                } else {
                    statusDiv.innerHTML = '‚ùå All generations failed';
                    statusDiv.className = 'status-badge show status-error';
                }
                
                button.textContent = '‚úì Generated';
                button.style.opacity = '1';
                
            } catch (error) {
                console.error('VEO3 Generation Error:', error);
                statusDiv.innerHTML = `‚ùå Error: ${error.message}`;
                statusDiv.className = 'status-badge show status-error';
                button.disabled = false;
                button.style.opacity = '1';
                button.textContent = 'üé¨ Generate in VEO3';
            }
        }
        
        async function generateSingleVideo(apiKey, fullPrompt, takeNumber, variationNumber) {
            try {
                // Prepare the request payload
                const payload = {
                    model: 'veo-3-generate-preview',
                    contents: [{
                        parts: [{
                            text: fullPrompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 1.0,
                        topP: 0.95,
                        topK: 40
                    }
                };
                
                // If there's an image, add it to the request
                if (uploadedImageBase64) {
                    const base64Data = uploadedImageBase64.split(',')[1];
                    const mimeType = uploadedImageBase64.split(',')[0].match(/:(.*?);/)[1];
                    
                    payload.contents[0].parts.unshift({
                        inlineData: {
                            mimeType: mimeType,
                            data: base64Data
                        }
                    });
                }
                
                // Make the API call to our Vercel serverless function
                const response = await fetch('/api/generate-video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Check if we got an operation ID (video generation is async)
                if (data.name) {
                    // Poll for completion
                    const result = await pollOperationForVariation(data.name, apiKey);
                    return result;
                } else if (data.candidates && data.candidates[0]) {
                    // Got immediate response
                    const videoUrl = extractVideoUrl(data);
                    return { success: true, videoUrl: videoUrl };
                } else {
                    throw new Error('Unexpected response format from API');
                }
                
            } catch (error) {
                return { success: false, error: error.message };
            }
        }
        
        async function pollOperationForVariation(operationName, apiKey) {
            const maxAttempts = 60; // 5 minutes max
            let attempts = 0;
            
            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(`/api/check-operation?operationName=${encodeURIComponent(operationName)}`);
                    const data = await response.json();
                    
                    if (data.done) {
                        if (data.error) {
                            return { success: false, error: data.error.message };
                        }
                        
                        const videoUrl = extractVideoUrl(data.response);
                        return { success: true, videoUrl: videoUrl };
                    }
                    
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
                    
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }
            
            return { success: false, error: 'Generation timed out' };
        }
        
        function extractVideoUrl(response) {
            // Try to extract video URL from various possible response structures
            if (response.candidates && response.candidates[0]) {
                const candidate = response.candidates[0];
                if (candidate.content && candidate.content.parts) {
                    for (const part of candidate.content.parts) {
                        if (part.fileData && part.fileData.fileUri) {
                            return part.fileData.fileUri;
                        }
                        if (part.videoMetadata && part.videoMetadata.uri) {
                            return part.videoMetadata.uri;
                        }
                    }
                }
            }
            return null;
        }
        
        // Auto-generate on page load
        window.addEventListener('load', function() {
            updateDurationWarning();
            // Removed auto-generation since there's no default script
        });
    </script>
</body>
</html>